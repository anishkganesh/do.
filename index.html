<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>do.</title>
    <!-- Minimalistic favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2NCA2NCI+PHRleHQgeD0iNSIgeT0iNTAiIGZvbnQtc2l6ZT0iNDgiIGZpbGw9IiMwMDAiPmRvLjwvdGV4dD48L3N2Zz4=">
    <style>
        body {
            font-family: 'Garamond', serif;
            margin: 0;
            background-color: #fafafa;
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fafafa;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.fade-out {
            opacity: 0;
        }

        h1 {
            color: #333;
            margin: 10px 0;
            font-size: 48px;
            text-align: center;
        }

        .top-section {
            text-align: center;
            margin-bottom: 10px;
        }

        .quote, .purpose {
            margin: 5px 0;
            font-size: 18px;
            transition: opacity 1s ease-in-out;
            opacity: 1;
        }

        .fade-out {
            opacity: 0;
        }

        .fade-in {
            opacity: 1;
        }

        .purpose {
            cursor: text;
        }

        .main-section {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 0 10px;
            box-sizing: border-box;
            align-items: stretch;
        }

        .task-columns {
            width: 70%;
            display: flex;
            justify-content: space-between;
            overflow: hidden;
            padding-right: 10px;
            box-sizing: border-box;
            flex-shrink: 0;
            flex-direction: column;
            height: 100%;
        }

        .task-columns .columns-wrapper {
            display: flex;
            flex: 1;
        }

        .column {
            width: 32%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .column h2 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin: 0;
            text-align: center;
        }

        .task-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
        }

        .task {
            background-color: #fff;
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            cursor: grab;
            border-left: 5px solid #8bc34a;
        }

        .dragging {
            opacity: 0.5;
        }

        /* Priority Color Coding */
        .task.low {
            border-left-color: #8bc34a;
        }

        .task.medium {
            border-left-color: #ff9800;
        }

        .task.high {
            border-left-color: #f44336;
        }

        /* Active and Completed Task Coloring */
        .task.active {
            background-color: #e3f2fd;
        }

        .task.completed {
            background-color: #d0f0c0;
            text-decoration: line-through;
            color: #999;
        }

        .task-list.over {
            border: 2px dashed #666;
        }

        /* Updated Sidebar CSS */
        .sidebar {
            width: 30%;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-y: auto;
            flex-shrink: 0;
            height: 100%;
        }

        .goals, .habit-streaks, .stats {
            margin-bottom: 20px;
        }

        /* Auto-scrolling goals */
        .goals-display {
            overflow: hidden;
            position: relative;
            height: 24px;
            width: 100%;
        }

        .goals-display .goal-container {
            display: flex;
            position: absolute;
            animation: scroll-goals linear infinite;
            white-space: nowrap;
        }

        .goal-item {
            margin-right: 50px;
            white-space: nowrap;
        }

        @keyframes scroll-goals {
            from {
                transform: translateX(var(--goals-scroll-start));
            }
            to {
                transform: translateX(var(--goals-scroll-end));
            }
        }

        /* Auto-scrolling stats */
        .stats-display {
            overflow: hidden;
            position: relative;
            height: 24px;
            width: 100%;
        }

        .stats-display .stats-container {
            display: flex;
            position: absolute;
            animation: scroll-stats linear infinite;
            white-space: nowrap;
        }

        .stats-item {
            margin-right: 50px;
            white-space: nowrap;
        }

        @keyframes scroll-stats {
            from {
                transform: translateX(var(--stats-scroll-start));
            }
            to {
                transform: translateX(var(--stats-scroll-end));
            }
        }

        /* Habit Streaks Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day {
            width: 20px;
            height: 20px;
            background-color: #e0e0e0;
            text-align: center;
            font-size: 12px;
            line-height: 20px;
        }

        /* Different intensities of green based on completion percentage */
        .calendar-day[data-completion="100"] {
            background-color: #006400;
            color: #fff;
        }

        .calendar-day[data-completion="75"] {
            background-color: #228B22;
            color: #fff;
        }

        .calendar-day[data-completion="50"] {
            background-color: #32CD32;
            color: #fff;
        }

        .calendar-day[data-completion="25"] {
            background-color: #7CFC00;
            color: #fff;
        }

        /* Input Form at the bottom */
        .input-form {
            padding: 10px;
            background-color: #fafafa;
        }

        .input-form textarea {
            width: 100%;
            height: 60px;
            padding: 8px;
            border: 1px solid #ccc;
            resize: none;
            font-family: 'Garamond', serif;
            padding-right: 10px;
            box-sizing: border-box;
        }

        input, select, textarea, button {
            font-family: 'Garamond', serif;
        }

        /* Minimalistic Input */
        .minimal-input {
            border: none;
            border-bottom: 1px solid #ccc;
            padding: 5px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            font-family: 'Garamond', serif;
        }

        /* Minimalistic Button */
        .minimal-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            color: inherit;
        }

        .minimal-button:hover {
            text-decoration: underline;
        }

        /* Task Edit Popup */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 300px;
            font-family: 'Garamond', serif;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .modal-buttons button {
            flex: 1;
            margin: 0 5px;
        }

        .goals-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .goals-list-item button {
            margin-left: 10px;
        }

        /* CSS Variables for dynamic scrolling */
        :root {
            --goals-scroll-start: 100%;
            --goals-scroll-end: -100%;
            --stats-scroll-start: 100%;
            --stats-scroll-end: -100%;
        }

        /* Authentication Buttons */
        #auth-buttons {
            position: absolute;
            top: 10px;
            right: 20px;
        }

        #auth-buttons button {
            margin-left: 10px;
        }

        #logout-button {
            position: absolute;
            top: 10px;
            right: 20px;
            display: none;
        }

        /* Error Message Styling */
        .error-message, .success-message {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        .success-message {
            color: green;
        }

        /* Share Modal */
        #share-modal .modal-content {
            width: 400px;
        }

        /* Adjusted spacing for buttons */
        .backup-import {
            display: flex;
            flex-direction: row;
            gap: 10px;
        }

        /* Exit Shared do. Button */
        #exit-shared-do-button {
            position: absolute;
            top: 10px;
            left: 20px;
            display: none;
        }

        /* Share Error Message */
        #share-error-message {
            color: red;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Responsive Sidebar */
        @media (max-width: 1200px) {
            .sidebar {
                width: 100%;
                margin-top: 20px;
                max-height: none;
                height: auto;
            }
            .main-section {
                flex-direction: column;
            }
            .task-columns {
                width: 100%;
                padding-right: 0;
                height: auto;
            }
        }

    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <h1>do.</h1>
    </div>

    <!-- Authentication Buttons -->
    <div id="auth-buttons">
        <button id="login-button" class="minimal-button" onclick="openLoginModal()">Login</button>
        <button id="register-button" class="minimal-button" onclick="openRegisterModal()">Register</button>
    </div>
    <button id="logout-button" class="minimal-button" onclick="logout()">Logout</button>

    <!-- Exit Shared do. Button -->
    <button id="exit-shared-do-button" class="minimal-button" onclick="exitSharedDo()">Exit Shared do.</button>

    <div class="top-section">
        <h1 id="page-title">do.</h1>
        <p class="quote" id="quote-text"></p>
        <p class="purpose" id="vision-text" contenteditable="true" onblur="saveVision()">Your purpose here</p>
    </div>

    <div class="main-section">
        <!-- Left: Task Columns -->
        <div class="task-columns">
            <div class="columns-wrapper">
                <div class="column">
                    <h2>To Do (<span id="todo-count">0</span>)</h2>
                    <ul class="task-list" id="todo-list">
                        <!-- Tasks to do -->
                    </ul>
                </div>
                <div class="column">
                    <h2>Active (<span id="active-count">0</span>)</h2>
                    <ul class="task-list" id="active-list">
                        <!-- Active tasks -->
                    </ul>
                </div>
                <div class="column">
                    <h2>Completed (<span id="completed-count">0</span>)</h2>
                    <ul class="task-list" id="completed-list">
                        <!-- Completed tasks -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Right: Goals, Habit Streaks, Fun Stats -->
        <div class="sidebar">
            <div class="goals">
                <h3>Your Goals</h3>
                <div class="goals-display" id="goals-display" onclick="openGoalsModal()">
                    <!-- Auto-scrolling goals will be displayed here -->
                    <div class="goal-container" id="goal-container">
                        <!-- Individual goal items -->
                    </div>
                </div>
                <input type="text" id="goal-input" class="minimal-input" placeholder="Enter timeframe and goal (e.g., 'Daily: Exercise')">
            </div>

            <div class="habit-streaks">
                <h3>Habit Streaks</h3>
                <div class="calendar" id="habit-calendar">
                    <!-- Calendar grid will be displayed here -->
                </div>
            </div>

            <div class="stats">
                <h3>Your Progress</h3>
                <div class="stats-display" id="stats-display">
                    <!-- Auto-scrolling stats will be displayed here -->
                    <div class="stats-container" id="stats-container">
                        <!-- Stats messages -->
                    </div>
                </div>
            </div>

            <!-- Backup, Import, and Share Buttons -->
            <div class="backup-import">
                <button class="minimal-button" onclick="exportData()">Export Data</button>
                <button class="minimal-button" onclick="document.getElementById('import-file').click()">Import Data</button>
                <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importData(event)">
                <button class="minimal-button" onclick="openShareModal()">Share do.</button>
            </div>
        </div>
    </div>

    <!-- Dump area at the bottom -->
    <div class="input-form">
        <!-- Dump tasks -->
        <h3>Tasks</h3>
        <textarea id="dump-tasks" placeholder="Enter tasks separated by new lines"></textarea>
    </div>

    <!-- Task Edit Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTaskModal()">&times;</span>
            <h3>Edit Task</h3>
            <input type="text" id="edit-task-title" class="minimal-input" placeholder="Task Title"><br>
            <input type="date" id="edit-task-date" class="minimal-input"><br>
            <select id="edit-task-priority" class="minimal-input">
                <option value="low">Low Priority</option>
                <option value="medium">Medium Priority</option>
                <option value="high">High Priority</option>
            </select><br>
            <select id="edit-task-type" class="minimal-input">
                <option value="task">Task</option>
                <option value="appointment">Appointment</option>
                <option value="habit">Habit</option>
            </select><br>
            <div class="modal-buttons">
                <button class="minimal-button" onclick="saveTaskEdits()">Save Changes</button>
                <button class="minimal-button" onclick="deleteTask(editingTaskId)">Delete Task</button>
            </div>
        </div>
    </div>

    <!-- Goals Management Modal -->
    <div id="goals-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGoalsModal()">&times;</span>
            <h3>Manage Goals</h3>
            <ul id="goals-list">
                <!-- Goals will be listed here with delete options -->
            </ul>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLoginModal()">&times;</span>
            <h3>Login</h3>
            <input type="text" id="login-username" class="minimal-input" placeholder="Username"><br>
            <input type="password" id="login-password" class="minimal-input" placeholder="Password"><br>
            <div class="error-message" id="login-error-message"></div>
            <div class="modal-buttons">
                <button class="minimal-button" onclick="login()">Login</button>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRegisterModal()">&times;</span>
            <h3>Register</h3>
            <input type="text" id="register-username" class="minimal-input" placeholder="Username"><br>
            <input type="email" id="register-email" class="minimal-input" placeholder="Email"><br>
            <input type="password" id="register-password" class="minimal-input" placeholder="Password"><br>
            <div class="error-message" id="register-error-message"></div>
            <div class="modal-buttons">
                <button class="minimal-button" onclick="register()">Register</button>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal -->
    <div id="verification-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeVerificationModal()">&times;</span>
            <h3>Email Verification</h3>
            <p>We've sent a verification code to your email. Please enter it below:</p>
            <!-- Display the code inline for simulation -->
            <p>Your verification code is: <span id="displayed-verification-code"></span></p>
            <input type="text" id="verification-code-input" class="minimal-input" placeholder="Verification Code"><br>
            <div class="error-message" id="verification-error-message"></div>
            <div class="modal-buttons">
                <button class="minimal-button" onclick="verifyEmail()">Verify</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShareModal()">&times;</span>
            <h3>Share do.</h3>
            <div id="share-section">
                <p>Enter the username of the person you want to share with:</p>
                <input type="text" id="share-username" class="minimal-input" placeholder="Username"><br>
                <div class="error-message" id="share-error-message"></div>
                <div class="success-message" id="share-success-message"></div>
                <div class="modal-buttons">
                    <button class="minimal-button" onclick="shareDo()">Share</button>
                </div>
            </div>
            <hr>
            <h3>do.s Shared with You</h3>
            <div id="shared-with-you-section">
                <ul id="shared-with-you-list">
                    <!-- List of do.s shared with you will go here -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Sample quotes
        const quotes = [
            "Believe you can and you're halfway there. – Theodore Roosevelt",
            "The future depends on what you do today. – Mahatma Gandhi",
            "Don’t watch the clock; do what it does. Keep going. – Sam Levenson",
            "Success is not final, failure is not fatal: It is the courage to continue that counts. – Winston Churchill",
            "Hardships often prepare ordinary people for an extraordinary destiny. – C.S. Lewis",
            "The only way to do great work is to love what you do. – Steve Jobs",
            "If you can dream it, you can achieve it. – Zig Ziglar",
            "Don’t limit your challenges. Challenge your limits.",
            "The secret of getting ahead is getting started. – Mark Twain",
            "It always seems impossible until it's done. – Nelson Mandela",
            "Your only limit is your mind.",
            "Dream big and dare to fail.",
            "The harder you work for something, the greater you'll feel when you achieve it.",
            "Don’t stop when you're tired. Stop when you're done.",
            "Do something today that your future self will thank you for.",
            "Little things make big days.",
            "It’s going to be hard, but hard does not mean impossible.",
            "Don’t wait for opportunity. Create it.",
            "Sometimes we’re tested not to show our weaknesses, but to discover our strengths.",
            "The key to success is to focus on goals, not obstacles."
        ];

        function getRandomQuote() {
            const randomIndex = Math.floor(Math.random() * quotes.length);
            return quotes[randomIndex];
        }

        // Function to get tailored quotes
        function getTailoredQuote() {
            const purpose = document.getElementById('vision-text').innerText;
            const randomGoal = goals.length > 0 ? goals[Math.floor(Math.random() * goals.length)] : null;
            const randomTask = tasks.length > 0 ? tasks[Math.floor(Math.random() * tasks.length)] : null;

            const tailoredQuotes = [];

            if (purpose && purpose !== 'Your purpose here') {
                tailoredQuotes.push(`Remember, your purpose is "${purpose}". Keep it in mind.`);
                tailoredQuotes.push(`Your vision "${purpose}" is within reach.`);
                tailoredQuotes.push(`Stay aligned with your purpose: "${purpose}".`);
            }

            if (randomGoal) {
                tailoredQuotes.push(`Stay focused on your ${randomGoal.timeframe} goal: "${randomGoal.text}".`);
                tailoredQuotes.push(`Every step counts towards "${randomGoal.text}".`);
                tailoredQuotes.push(`Your goal "${randomGoal.text}" awaits your action.`);
            }

            if (randomTask) {
                tailoredQuotes.push(`Don't forget to ${randomTask.title}. You're making progress!`);
                tailoredQuotes.push(`"${randomTask.title}" is a step closer to success.`);
                tailoredQuotes.push(`Keep pushing on "${randomTask.title}".`);
            }

            if (tailoredQuotes.length > 0) {
                return tailoredQuotes[Math.floor(Math.random() * tailoredQuotes.length)];
            } else {
                return null;
            }
        }

        function updateQuote() {
            const quoteElement = document.getElementById('quote-text');

            // Fade out
            quoteElement.classList.add('fade-out');

            setTimeout(() => {
                let quote;
                if (Math.random() < 0.5) {
                    quote = getTailoredQuote();
                }

                if (!quote) {
                    quote = getRandomQuote();
                }

                // Update the quote text
                quoteElement.innerText = quote;

                // Fade in
                quoteElement.classList.remove('fade-out');
                quoteElement.classList.add('fade-in');

                // Remove fade-in class after animation
                setTimeout(() => {
                    quoteElement.classList.remove('fade-in');
                }, 1000);

            }, 1000);
        }

        // Initial quote setup
        document.getElementById('quote-text').innerText = getRandomQuote();

        // Update quote every minute
        setInterval(updateQuote, 60000);

        // Task management
        let tasks = [];
        let goals = [];

        let editingTaskId = null;
        let currentUser = null;
        let verificationCode = null;
        let pendingUser = null;
        let viewingSharedDo = false;
        let viewedUser = null;

        // Load data from LocalStorage on page load
        window.onload = function() {
            checkAuthStatus();

            // Minimalistic loading screen
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('fade-out');
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                }, 500);
            }, 500);

            // Event listeners for Enter and Shift+Enter
            document.getElementById('dump-tasks').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    processDumpedTasks();
                }
            });

            document.getElementById('goal-input').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addGoal();
                }
            });

            // Enter key submits login form
            document.getElementById('login-modal').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && document.getElementById('login-modal').style.display === 'block') {
                    e.preventDefault();
                    login();
                }
            });

            // Enter key submits registration form
            document.getElementById('register-modal').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && document.getElementById('register-modal').style.display === 'block') {
                    e.preventDefault();
                    register();
                }
            });

            // Enter key submits verification code
            document.getElementById('verification-modal').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && document.getElementById('verification-modal').style.display === 'block') {
                    e.preventDefault();
                    verifyEmail();
                }
            });

            // Escape key closes modals
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    closeTaskModal();
                    closeGoalsModal();
                    closeLoginModal();
                    closeRegisterModal();
                    closeVerificationModal();
                    closeShareModal();
                }
            });
        };

        function processDumpedTasks() {
            const dumpedTasks = document.getElementById('dump-tasks').value;

            if (!dumpedTasks) {
                alert('Please enter tasks.');
                return;
            }

            const taskLines = dumpedTasks.split('\n');

            taskLines.forEach(line => {
                const title = line.trim();
                if (title) {
                    const task = simulateLLMProcessing(title);
                    if (Array.isArray(task)) {
                        tasks.push(...task);
                    } else {
                        tasks.push(task);
                    }
                }
            });

            saveData(); // Save tasks to LocalStorage
            renderTasks();
            document.getElementById('dump-tasks').value = '';
        }

        function simulateLLMProcessing(title) {
            const sizes = ['small', 'medium', 'large'];
            const priorities = ['low', 'medium', 'high'];
            const types = ['task', 'appointment', 'habit'];

            const size = sizes[Math.floor(Math.random() * sizes.length)];
            const priority = priorities[Math.floor(Math.random() * priorities.length)];
            const type = types[Math.floor(Math.random() * types.length)];
            const date = new Date().toISOString().split('T')[0]; // Today's date

            const task = {
                id: Date.now() + Math.random(),
                title,
                description: '',
                date,
                priority,
                size,
                type,
                status: 'todo' // Default status
            };

            if (size === 'large') {
                return chunkLargeTask(task);
            } else {
                return task;
            }
        }

        function chunkLargeTask(task) {
            const chunkedTasks = [];
            for (let i = 1; i <= 3; i++) {
                chunkedTasks.push({
                    ...task,
                    id: Date.now() + Math.random(),
                    title: `${task.title} - Part ${i}`,
                    size: 'medium',
                    status: 'todo'
                });
            }
            return chunkedTasks;
        }

        function renderTasks() {
            const todoList = document.getElementById('todo-list');
            const activeList = document.getElementById('active-list');
            const completedList = document.getElementById('completed-list');
            const todoCount = document.getElementById('todo-count');
            const activeCount = document.getElementById('active-count');
            const completedCount = document.getElementById('completed-count');

            todoList.innerHTML = '';
            activeList.innerHTML = '';
            completedList.innerHTML = '';

            let todoTasks = 0;
            let activeTasks = 0;
            let completedTasks = 0;

            tasks.forEach(task => {
                const taskItem = document.createElement('li');
                taskItem.className = `task ${task.size} ${task.priority}`;
                taskItem.draggable = !viewingSharedDo;
                taskItem.innerHTML = `
                    <strong>${task.title}</strong><br>
                    ${task.date ? 'Date: ' + task.date + '<br>' : ''}
                    Priority: ${task.priority}<br>
                    Type: ${task.type}
                `;
                taskItem.dataset.id = task.id;

                if (task.status === 'active') {
                    taskItem.classList.add('active');
                } else if (task.status === 'completed') {
                    taskItem.classList.add('completed');
                }

                if (!viewingSharedDo) {
                    // Drag and Drop Event Listeners
                    taskItem.addEventListener('dragstart', handleDragStart);
                    taskItem.addEventListener('dragend', handleDragEnd);
                }

                // Edit Task on Double Click
                if (!viewingSharedDo) {
                    taskItem.addEventListener('dblclick', () => openTaskModal(task.id));
                }

                if (task.status === 'todo') {
                    todoList.appendChild(taskItem);
                    todoTasks++;
                } else if (task.status === 'active') {
                    activeList.appendChild(taskItem);
                    activeTasks++;
                } else if (task.status === 'completed') {
                    completedList.appendChild(taskItem);
                    completedTasks++;
                }
            });

            todoCount.innerText = todoTasks;
            activeCount.innerText = activeTasks;
            completedCount.innerText = completedTasks;

            updateHabitStreaks();
            updateFunStats();
        }

        // Drag-and-Drop Functions
        let draggedTaskId = null;

        function handleDragStart(e) {
            draggedTaskId = e.target.dataset.id;
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        const lists = document.querySelectorAll('.task-list');
        lists.forEach(list => {
            list.addEventListener('dragover', handleDragOver);
            list.addEventListener('drop', handleDrop);
            list.addEventListener('dragenter', handleDragEnter);
            list.addEventListener('dragleave', handleDragLeave);
        });

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.currentTarget.classList.add('over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('over');
        }

        function handleDrop(e) {
            e.currentTarget.classList.remove('over');
            const list = e.currentTarget;
            const task = tasks.find(t => t.id == draggedTaskId);

            if (list.id === 'todo-list') {
                task.status = 'todo';
            } else if (list.id === 'active-list') {
                task.status = 'active';
            } else if (list.id === 'completed-list') {
                task.status = 'completed';
            }

            saveData();
            renderTasks();
        }

        // Goals management
        function addGoal() {
            const goalText = document.getElementById('goal-input').value;

            if (!goalText) {
                alert('Please enter a goal.');
                return;
            }

            const [timeframe, ...goalArray] = goalText.split(':');
            if (!goalArray.length) {
                alert('Please enter a timeframe and a goal separated by a colon (e.g., "Daily: Exercise").');
                return;
            }
            const goal = {
                text: goalArray.join(':').trim(),
                timeframe: timeframe.trim().toLowerCase()
            };

            goals.push(goal);
            saveData(); // Save goals to LocalStorage
            renderGoals();

            document.getElementById('goal-input').value = '';
        }

        function renderGoals() {
            const goalContainer = document.getElementById('goal-container');
            goalContainer.innerHTML = '';

            goals.forEach((goal) => {
                const goalItem = document.createElement('span');
                goalItem.innerText = `${capitalizeFirstLetter(goal.timeframe)} Goal: ${goal.text}`;
                goalItem.classList.add('goal-item');
                goalContainer.appendChild(goalItem);
            });

            // Calculate scrolling parameters
            const goalDisplay = document.getElementById('goals-display');
            const containerWidth = goalDisplay.offsetWidth;
            const contentWidth = goalContainer.scrollWidth;

            const totalScrollDistance = containerWidth + contentWidth;

            const root = document.documentElement;
            root.style.setProperty('--goals-scroll-start', containerWidth + 'px');
            root.style.setProperty('--goals-scroll-end', -contentWidth + 'px');

            const speed = 50; // pixels per second
            const duration = totalScrollDistance / speed;

            goalContainer.style.animationDuration = duration + 's';
        }

        function openGoalsModal() {
            if (viewingSharedDo) return; // Prevent editing when viewing shared do.
            const goalsList = document.getElementById('goals-list');
            goalsList.innerHTML = '';

            goals.forEach((goal, index) => {
                const goalItem = document.createElement('li');
                goalItem.classList.add('goals-list-item');
                const goalText = document.createElement('span');
                goalText.innerText = `${capitalizeFirstLetter(goal.timeframe)} Goal: ${goal.text}`;
                const deleteButton = document.createElement('button');
                deleteButton.innerText = 'Delete';
                deleteButton.className = 'minimal-button';
                deleteButton.onclick = () => {
                    deleteGoal(index);
                    closeGoalsModal();
                };
                goalItem.appendChild(goalText);
                goalItem.appendChild(deleteButton);
                goalsList.appendChild(goalItem);
            });

            document.getElementById('goals-modal').style.display = 'block';
        }

        function closeGoalsModal() {
            document.getElementById('goals-modal').style.display = 'none';
        }

        function deleteGoal(index) {
            goals.splice(index, 1);
            saveData(); // Save changes to LocalStorage
            renderGoals();
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        // Vision and Purpose
        function saveVision() {
            const vision = document.getElementById('vision-text').innerText;
            if (currentUser) {
                localStorage.setItem(currentUser + '_vision', vision);
            } else {
                localStorage.setItem('guest_vision', vision);
            }
        }

        function loadVision() {
            let vision;
            if (currentUser) {
                vision = localStorage.getItem(currentUser + '_vision');
            } else {
                vision = localStorage.getItem('guest_vision');
            }

            if (vision) {
                document.getElementById('vision-text').innerText = vision;
            } else {
                document.getElementById('vision-text').innerText = 'Your purpose here';
            }
        }

        // Habit Streaks
        function updateHabitStreaks() {
            const habitCalendar = document.getElementById('habit-calendar');
            habitCalendar.innerHTML = '';

            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const habitTasks = tasks.filter(task => task.type === 'habit');

            const habitDates = {};
            for (let day = 1; day <= daysInMonth; day++) {
                habitDates[day] = { total: 0, completed: 0 };
            }

            habitTasks.forEach(task => {
                const taskDate = new Date(task.date).getDate();
                if (habitDates[taskDate]) {
                    habitDates[taskDate].total++;
                    if (task.status === 'completed') {
                        habitDates[taskDate].completed++;
                    }
                }
            });

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                const habitData = habitDates[day];

                if (habitData.total > 0) {
                    const completionPercentage = (habitData.completed / habitData.total) * 100;

                    if (completionPercentage === 100) {
                        dayCell.dataset.completion = '100';
                    } else if (completionPercentage >= 75) {
                        dayCell.dataset.completion = '75';
                    } else if (completionPercentage >= 50) {
                        dayCell.dataset.completion = '50';
                    } else if (completionPercentage >= 25) {
                        dayCell.dataset.completion = '25';
                    }
                }

                dayCell.innerText = day;
                habitCalendar.appendChild(dayCell);
            }
        }

        // Fun Task Statistics
        function updateFunStats() {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = '';

            const smallTasksCompleted = tasks.filter(task => task.size === 'small' && task.status === 'completed').length;
            const mediumTasksCompleted = tasks.filter(task => task.size === 'medium' && task.status === 'completed').length;
            const largeTasksCompleted = tasks.filter(task => task.size === 'large' && task.status === 'completed').length;

            const habitTasks = tasks.filter(task => task.type === 'habit' && task.status === 'completed');
            const habitNames = [...new Set(habitTasks.map(task => task.title))];

            // Calculate habit streaks
            const habitStreaks = {};
            habitNames.forEach(habitName => {
                let streak = 0;
                let maxStreak = 0;
                const sortedTasks = tasks.filter(task => task.title === habitName && task.status === 'completed')
                    .sort((a, b) => new Date(a.date) - new Date(b.date));
                let lastDate = null;
                sortedTasks.forEach(task => {
                    const currentDate = new Date(task.date);
                    if (lastDate) {
                        const diff = (currentDate - lastDate) / (1000 * 60 * 60 * 24);
                        if (diff === 1) {
                            streak++;
                        } else {
                            streak = 1;
                        }
                    } else {
                        streak = 1;
                    }
                    if (streak > maxStreak) {
                        maxStreak = streak;
                    }
                    lastDate = currentDate;
                });
                habitStreaks[habitName] = maxStreak;
            });

            const statsMessages = [
                `You've completed ${largeTasksCompleted} big tasks, ${mediumTasksCompleted} medium tasks, and ${smallTasksCompleted} small tasks.`,
                ...Object.entries(habitStreaks).map(([habit, streak]) => `Your longest streak for ${habit} is ${streak} days! Keep it up!`)
            ];

            statsMessages.forEach(message => {
                const statItem = document.createElement('span');
                statItem.innerText = message;
                statItem.classList.add('stats-item');
                statsContainer.appendChild(statItem);
            });

            // Calculate scrolling parameters
            const statsDisplay = document.getElementById('stats-display');
            const containerWidth = statsDisplay.offsetWidth;
            const contentWidth = statsContainer.scrollWidth;

            const totalScrollDistance = containerWidth + contentWidth;

            const root = document.documentElement;
            root.style.setProperty('--stats-scroll-start', containerWidth + 'px');
            root.style.setProperty('--stats-scroll-end', -contentWidth + 'px');

            const speed = 50; // pixels per second
            const duration = totalScrollDistance / speed;

            statsContainer.style.animationDuration = duration + 's';
        }

        // Task Editing
        function openTaskModal(taskId) {
            if (viewingSharedDo) return; // Prevent editing when viewing shared do.
            editingTaskId = taskId;
            const task = tasks.find(t => t.id == taskId);

            document.getElementById('edit-task-title').value = task.title;
            document.getElementById('edit-task-date').value = task.date;
            document.getElementById('edit-task-priority').value = task.priority;
            document.getElementById('edit-task-type').value = task.type;

            document.getElementById('task-modal').style.display = 'block';
        }

        function closeTaskModal() {
            document.getElementById('task-modal').style.display = 'none';
            editingTaskId = null;
        }

        function saveTaskEdits() {
            const task = tasks.find(t => t.id == editingTaskId);

            task.title = document.getElementById('edit-task-title').value;
            task.date = document.getElementById('edit-task-date').value;
            task.priority = document.getElementById('edit-task-priority').value;
            task.type = document.getElementById('edit-task-type').value;

            saveData(); // Save tasks to LocalStorage
            closeTaskModal();
            renderTasks();
        }

        function deleteTask(taskId) {
            tasks = tasks.filter(task => task.id != taskId);
            saveData(); // Save tasks to LocalStorage
            closeTaskModal();
            renderTasks();
        }

        // Close the modals when clicking outside of them
        window.onclick = function(event) {
            const modals = ['task-modal', 'goals-modal', 'login-modal', 'register-modal', 'verification-modal', 'share-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // LocalStorage Functions
        function saveData() {
            const data = {
                tasks: tasks,
                goals: goals,
                vision: document.getElementById('vision-text').innerText
            };
            if (currentUser) {
                localStorage.setItem(currentUser + '_data', JSON.stringify(data));
                updateSharedData();
            } else {
                localStorage.setItem('guest_data', JSON.stringify(data));
            }
        }

        function loadData() {
            let storedData;

            if (currentUser) {
                storedData = localStorage.getItem(currentUser + '_data');
            } else {
                storedData = localStorage.getItem('guest_data');
            }

            if (storedData) {
                const data = JSON.parse(storedData);
                tasks = data.tasks || [];
                goals = data.goals || [];
                document.getElementById('vision-text').innerText = data.vision || 'Your purpose here';
            } else {
                tasks = [];
                goals = [];
                document.getElementById('vision-text').innerText = 'Your purpose here';
            }

            renderTasks();
            renderGoals();
            updateHabitStreaks();
            updateFunStats();
        }

        // Backup and Import Functions
        function exportData() {
            const data = {
                tasks: tasks,
                goals: goals,
                vision: document.getElementById('vision-text').innerText
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'do_backup_' + (currentUser || 'guest') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('No file selected.');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.tasks && data.goals) {
                        tasks = data.tasks;
                        goals = data.goals;
                        document.getElementById('vision-text').innerText = data.vision || 'Your purpose here';

                        saveData();
                        loadData();
                        alert('Data imported successfully.');
                    } else {
                        alert('Invalid data format.');
                    }
                } catch (error) {
                    alert('Error parsing JSON file.');
                }
            };
            reader.readAsText(file);
            // Reset the file input
            event.target.value = '';
        }

        // Authentication Functions
        function checkAuthStatus() {
            currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                document.getElementById('logout-button').style.display = 'block';
                document.getElementById('auth-buttons').style.display = 'none';
            } else {
                document.getElementById('logout-button').style.display = 'none';
                document.getElementById('auth-buttons').style.display = 'block';
            }
            viewingSharedDo = false;
            viewedUser = null;
            document.getElementById('page-title').innerText = 'do.';
            document.getElementById('vision-text').contentEditable = !viewingSharedDo;
            document.getElementById('exit-shared-do-button').style.display = 'none';
            loadData();
        }

        function openLoginModal() {
            document.getElementById('login-error-message').innerText = '';
            document.getElementById('login-modal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('login-modal').style.display = 'none';
        }

        function openRegisterModal() {
            document.getElementById('register-error-message').innerText = '';
            document.getElementById('register-modal').style.display = 'block';
        }

        function closeRegisterModal() {
            document.getElementById('register-modal').style.display = 'none';
        }

        function login() {
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            const storedUser = JSON.parse(localStorage.getItem('user_' + username));
            if (storedUser && storedUser.password === password) {
                currentUser = username;
                localStorage.setItem('currentUser', currentUser);
                closeLoginModal();
                checkAuthStatus();
                document.getElementById('login-error-message').innerText = '';
            } else {
                document.getElementById('login-error-message').innerText = 'Invalid username or password.';
            }
        }

        function register() {
            const username = document.getElementById('register-username').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;

            if (!username || !email || !password) {
                document.getElementById('register-error-message').innerText = 'All fields are required.';
                return;
            }

            const userExists = localStorage.getItem('user_' + username);
            if (userExists) {
                document.getElementById('register-error-message').innerText = 'Username already exists. Please choose another one.';
            } else {
                // Simulate sending a verification email
                verificationCode = Math.floor(100000 + Math.random() * 900000).toString(); // 6-digit code
                // Display the code inline for simulation purposes
                document.getElementById('displayed-verification-code').innerText = verificationCode;

                pendingUser = {
                    username: username,
                    password: password,
                    email: email
                };

                closeRegisterModal();
                openVerificationModal();
            }
        }

        function openVerificationModal() {
            document.getElementById('verification-error-message').innerText = '';
            document.getElementById('verification-modal').style.display = 'block';
        }

        function closeVerificationModal() {
            document.getElementById('verification-modal').style.display = 'none';
            pendingUser = null;
            verificationCode = null;
        }

        function verifyEmail() {
            const enteredCode = document.getElementById('verification-code-input').value.trim();
            if (enteredCode === verificationCode) {
                // Save the user
                localStorage.setItem('user_' + pendingUser.username, JSON.stringify({
                    password: pendingUser.password,
                    email: pendingUser.email
                }));
                currentUser = pendingUser.username;
                localStorage.setItem('currentUser', currentUser);
                closeVerificationModal();
                checkAuthStatus();
            } else {
                document.getElementById('verification-error-message').innerText = 'Incorrect verification code.';
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            checkAuthStatus();
        }

        // Sharing Functionality
        function openShareModal() {
            document.getElementById('share-error-message').innerText = '';
            document.getElementById('share-success-message').innerText = '';
            document.getElementById('share-username').value = '';

            // Populate the list of do.s shared with the user
            const sharedWithYouList = document.getElementById('shared-with-you-list');
            sharedWithYouList.innerHTML = '';

            const sharedWithYou = getSharedWithYou();
            if (sharedWithYou.length > 0) {
                sharedWithYou.forEach(username => {
                    const listItem = document.createElement('li');
                    const userNameSpan = document.createElement('span');
                    userNameSpan.innerText = username;
                    const viewButton = document.createElement('button');
                    viewButton.innerText = 'View';
                    viewButton.className = 'minimal-button';
                    viewButton.style.marginLeft = '10px';
                    viewButton.onclick = () => {
                        viewSharedDo(username);
                        closeShareModal();
                    };
                    listItem.appendChild(userNameSpan);
                    listItem.appendChild(viewButton);
                    sharedWithYouList.appendChild(listItem);
                });
            } else {
                sharedWithYouList.innerHTML = '<li>No do.s shared with you.</li>';
            }

            // Show or hide the 'Exit Shared do.' button
            const exitSharedDoButton = document.getElementById('exit-shared-do-button');
            if (viewingSharedDo) {
                exitSharedDoButton.style.display = 'block';
            } else {
                exitSharedDoButton.style.display = 'none';
            }

            document.getElementById('share-modal').style.display = 'block';
        }

        function closeShareModal() {
            document.getElementById('share-modal').style.display = 'none';
        }

        function shareDo() {
            if (!currentUser) {
                document.getElementById('share-error-message').innerText = 'Please login to share your do.';
                return;
            }

            const shareUsername = document.getElementById('share-username').value.trim();
            if (!shareUsername) {
                document.getElementById('share-error-message').innerText = 'Please enter a username.';
                return;
            }

            if (shareUsername === currentUser) {
                document.getElementById('share-error-message').innerText = 'You cannot share with yourself.';
                return;
            }

            const userExists = localStorage.getItem('user_' + shareUsername);
            if (!userExists) {
                document.getElementById('share-error-message').innerText = 'User does not exist.';
                return;
            }

            // Simulate sharing by saving data under a shared key
            const data = {
                tasks: tasks,
                goals: goals,
                vision: document.getElementById('vision-text').innerText
            };

            localStorage.setItem('shared_from_' + currentUser + '_to_' + shareUsername, JSON.stringify(data));
            document.getElementById('share-error-message').innerText = '';
            document.getElementById('share-success-message').innerText = 'Your do. has been shared successfully!';
        }

        function getSharedWithYou() {
            const sharedWithYou = [];
            const prefix = 'shared_from_';
            const suffix = '_to_' + (currentUser || 'guest');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix) && key.endsWith(suffix)) {
                    const sharedFromUser = key.substring(prefix.length, key.length - suffix.length);
                    sharedWithYou.push(sharedFromUser);
                }
            }
            return sharedWithYou;
        }

        function viewSharedDo(username) {
            if (!username) {
                alert('Username not specified.');
                return;
            }

            if (username === currentUser) {
                alert('You are already viewing your own do.');
                return;
            }

            const sharedDataKey = 'shared_from_' + username + '_to_' + (currentUser || 'guest');
            const sharedData = localStorage.getItem(sharedDataKey);

            if (!sharedData) {
                alert(`${username} has not shared their do. with you.`);
                return;
            }

            const data = JSON.parse(sharedData);
            tasks = data.tasks || [];
            goals = data.goals || [];
            if (data.vision) {
                document.getElementById('vision-text').innerText = data.vision;
            } else {
                document.getElementById('vision-text').innerText = 'Their purpose here';
            }

            viewingSharedDo = true;
            viewedUser = username;
            document.getElementById('page-title').innerText = `${username}'s do.`;
            document.getElementById('vision-text').contentEditable = false;
            document.getElementById('exit-shared-do-button').style.display = 'block';
            renderTasks();
            renderGoals();
        }

        function exitSharedDo() {
            if (viewingSharedDo) {
                viewingSharedDo = false;
                viewedUser = null;
                document.getElementById('page-title').innerText = 'do.';
                document.getElementById('vision-text').contentEditable = true;
                document.getElementById('exit-shared-do-button').style.display = 'none';
                loadData();
                renderTasks();
                renderGoals();
            }
        }

        function updateSharedData() {
            // Update the shared data when tasks or goals change
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('shared_from_' + currentUser + '_to_')) {
                    const data = {
                        tasks: tasks,
                        goals: goals,
                        vision: document.getElementById('vision-text').innerText
                    };
                    localStorage.setItem(key, JSON.stringify(data));
                }
            }
        }

    </script>

</body>
</html>
